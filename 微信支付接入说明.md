# 微信支付接入说明

## 配置信息

### 1. 微信商户号信息
- **商户号**: 1723243294
- **商户API密钥**: Ht19961210Cgj888888YidingFADACAI
- **小程序AppID**: wxb61e3bbcd9bebc43

### 2. 支付回调地址
- **回调URL**: https://new-travel-2gy6d6oy7ee5fb0e.service.tcloudbase.com/paymentCallback

## 部署步骤

### 1. 安装依赖
```bash
cd cloudfunctions/payment
npm install

cd ../paymentCallback
npm install
```

### 2. 部署云函数
```bash
# 在微信开发者工具中右键点击云函数文件夹
# 选择"上传并部署：云端安装依赖"
```

### 3. 配置微信商户平台

#### 3.1 配置支付回调地址
1. 登录微信商户平台 (https://pay.weixin.qq.com)
2. 进入"产品中心" -> "开发配置"
3. 设置"支付回调地址"为：
   ```
   https://new-travel-2gy6d6oy7ee5fb0e.service.tcloudbase.com/paymentCallback
   ```

#### 3.2 配置API安全
1. 在"账户中心" -> "API安全"中确认API密钥
2. 确保API密钥与代码中的配置一致

### 4. 上传证书文件（可选）
如果需要退款功能，需要上传商户证书：
1. 将 `apiclient_cert.pem` 和 `apiclient_key.pem` 上传到云函数
2. 在退款功能中使用证书进行签名

## 功能说明

### 1. 创建支付订单
- 调用微信统一下单API
- 生成小程序支付参数
- 返回支付所需参数

### 2. 支付回调处理
- 接收微信支付结果通知
- 验证签名确保安全性
- 更新订单状态

### 3. 查询支付状态
- 调用微信订单查询API
- 获取实时支付状态
- 更新本地订单信息

### 4. 退款功能
- 调用微信退款API
- 支持部分退款和全额退款
- 更新订单退款状态

## 测试流程

### 1. 开发环境测试
1. 在微信开发者工具中测试支付功能
2. 使用测试金额进行支付测试
3. 检查支付回调是否正常

### 2. 生产环境测试
1. 使用真实微信账号测试
2. 验证支付流程完整性
3. 确认订单状态更新正确

## 注意事项

### 1. 安全性
- API密钥请妥善保管，不要泄露
- 支付回调必须验证签名
- 建议使用HTTPS协议

### 2. 错误处理
- 支付失败时提供友好提示
- 网络异常时重试机制
- 记录详细错误日志

### 3. 金额处理
- 微信支付金额单位为分
- 注意金额精度处理
- 避免金额计算错误

### 4. 订单管理
- 确保订单号唯一性
- 及时更新订单状态
- 保留支付相关记录

## 常见问题

### Q: 支付失败怎么办？
A: 检查以下几点：
1. 商户号配置是否正确
2. API密钥是否匹配
3. 回调地址是否可访问
4. 网络连接是否正常

### Q: 如何查看支付日志？
A: 在微信云开发控制台查看云函数日志

### Q: 退款功能需要证书吗？
A: 是的，退款需要商户证书文件

### Q: 测试环境如何配置？
A: 可以使用微信支付的沙箱环境进行测试 