<!--pages/admin/admin.wxml-->
<view class="container">
  <!-- åœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ æƒé™ä¿¡æ¯æ˜¾ç¤º -->
  <view class="permission-info" wx:if="{{isAdmin}}">
    <text class="permission-text">
      å½“å‰æƒé™: {{isSuperAdmin ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'}}
    </text>
  </view>
  <!-- å¯¼èˆªèœå• -->
  <view class="nav-menu">
    <view class="nav-item {{currentPage === 'products' ? 'active' : ''}}"
          bindtap="switchPage"
          data-page="products">
      <text>äº§å“ç®¡ç†</text>
    </view>
    <view class="nav-item {{currentPage === 'banners' ? 'active' : ''}}"
          bindtap="switchPage"
          data-page="banners">
      <text>è½®æ’­å›¾ç®¡ç†</text>
    </view>
    <view class="nav-item {{currentPage === 'orders' ? 'active' : ''}}"
          bindtap="switchPage"
          data-page="orders">
      <text>è®¢å•ç®¡ç†</text>
    </view>
    <view class="nav-item {{currentPage === 'refunds' ? 'active' : ''}}"
          bindtap="switchPage"
          data-page="refunds">
      <text>é€€æ¬¾ç®¡ç†</text>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜ç®¡ç†æŒ‰é’® -->
  <view class="admin-manage-section" wx:if="{{isSuperAdmin}}">
    <button class="admin-manage-btn" bindtap="showAdminManagement">ç®¡ç†å‘˜ç®¡ç†</button>
  </view>

  <!-- æ•°æ®åº“æ“ä½œåŒºåŸŸ - ä¸´æ—¶å»æ‰æƒé™æ£€æŸ¥ï¼Œæ–¹ä¾¿è°ƒè¯• -->
  <view class="database-section">
    <view class="section-title">æ•°æ®åº“æ“ä½œ</view>
    <view class="database-actions">
      <button class="btn-database" bindtap="initDatabase" loading="{{initLoading}}">åˆå§‹åŒ–æ•°æ®åº“</button>
      <button class="btn-database btn-danger" bindtap="clearDatabase" loading="{{clearLoading}}">æ¸…ç†æ•°æ®åº“</button>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area">
    <!-- äº§å“ç®¡ç† -->
    <view wx:if="{{currentPage === 'products'}}" class="page-content">
      <view class="header-actions">
        <text class="page-title">äº§å“ç®¡ç†</text>
        <button class="btn-primary" bindtap="addProduct">æ·»åŠ äº§å“</button>
      </view>
      
      <view class="data-list">
        <view class="data-item" wx:for="{{products}}" wx:key="_id">
          <image class="item-image" src="{{item.coverImage}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-title">{{item.title}}</text>
            <!-- ä»·æ ¼å’ŒçŠ¶æ€åŒè¡Œæ˜¾ç¤º -->
            <view class="item-price-row">
              <text class="item-price">Â¥{{item.adultPrice}}</text>
              <text class="status-tag {{item.status === 'active' ? 'status-active' : 'status-inactive'}}">
                {{item.status === 'active' ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}}
              </text>
            </view>
            <!-- çƒ­é—¨æ¨èæ ‡ç­¾ -->
            <view class="item-status-tags" wx:if="{{item.isHot}}">
              <text class="hot-label">ğŸ”¥ çƒ­é—¨æ¨è</text>
              <text class="hot-sort">æ’åº: {{item.hotSort || 0}}</text>
            </view>
          </view>
          <view class="item-actions">
            <button class="btn-secondary" bindtap="editProduct" data-id="{{item._id}}">ç¼–è¾‘</button>
            <button class="btn-danger" bindtap="deleteProduct" data-id="{{item._id}}">åˆ é™¤</button>
            <button class="btn-status-toggle {{item.status === 'active' ? 'btn-danger' : 'btn-primary'}}" 
                    bindtap="simpleToggleStatus" 
                    data-id="{{item._id}}" 
                    data-status="{{item.status}}">
              {{item.status === 'active' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}}
            </button>
            <button class="btn-hot" bindtap="toggleHot" data-id="{{item._id}}" data-hot="{{item.isHot}}">
              {{item.isHot ? 'å–æ¶ˆçƒ­é—¨' : 'è®¾ä¸ºçƒ­é—¨'}}
            </button>
          </view>
        </view>
      </view>
      
      <view class="empty-state" wx:if="{{products.length === 0 && !loading}}">
        <text>æš‚æ— äº§å“æ•°æ®</text>
      </view>
    </view>

    <!-- è®¢å•ç®¡ç† -->
    <view wx:if="{{currentPage === 'orders'}}" class="page-content">
      <view class="page-header">
        <text class="page-title">è®¢å•ç®¡ç†</text>
      </view>

      <!-- æœç´¢åŒºåŸŸ -->
      <view class="search-section">
        <view class="search-bar">
          <input class="search-input"
                 placeholder="è¯·è¾“å…¥è®¢å•å·æœç´¢"
                 value="{{searchOrderNo}}"
                 bindinput="onSearchOrderInput" />
          <button class="search-btn" bindtap="searchOrders">æœç´¢</button>
          <button class="clear-btn" bindtap="clearSearch" wx:if="{{searchOrderNo}}">æ¸…ç©º</button>
        </view>
      </view>

      <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
      <view class="batch-actions" wx:if="{{orders.length > 0}}">
        <view class="batch-select">
          <view class="select-all" bindtap="toggleSelectAll">
            <view class="custom-checkbox {{selectAll ? 'checked' : ''}}">
              <text class="checkbox-icon" wx:if="{{selectAll}}">âœ“</text>
            </view>
            <text>å…¨é€‰</text>
          </view>
          <text class="selected-count" wx:if="{{selectedOrders.length > 0}}">
            å·²é€‰æ‹© {{selectedOrders.length}} é¡¹
          </text>
        </view>
        <view class="batch-buttons" wx:if="{{showBatchActions}}">
          <button class="batch-delete-btn" bindtap="batchDeleteOrders">æ‰¹é‡åˆ é™¤</button>
        </view>
      </view>

      <!-- è®¢å•åˆ—è¡¨ -->
      <view class="data-list" wx:if="{{orders.length > 0}}">
        <view class="order-item" wx:for="{{orders}}" wx:key="_id">
          <view class="order-checkbox" bindtap="toggleSelectOrder" data-id="{{item._id}}">
            <view class="simple-checkbox {{selectedOrders.indexOf(item._id) > -1 ? 'selected' : 'unselected'}}">
              âœ“
            </view>
          </view>
          <view class="order-info" bindtap="viewOrderDetail" data-id="{{item._id}}">
            <view class="order-header">
              <text class="order-no">è®¢å•å·: {{item.orderNo}}</text>
              <text class="order-status status-{{item.status}}">{{item.statusText}}</text>
            </view>
            <view class="order-details">
              <text class="order-product">{{item.productTitle}}</text>
              <text class="order-price">Â¥{{item.totalPrice}}</text>
            </view>
            <view class="order-meta">
              <text class="order-time">{{item.createTime}}</text>
              <text class="order-user">ç”¨æˆ·: {{item.contactName || 'æœªçŸ¥'}}</text>
            </view>
          </view>
          <view class="order-actions">
            <button class="btn-detail" bindtap="viewOrderDetail" data-id="{{item._id}}">è¯¦æƒ…</button>
            <button class="btn-delete" bindtap="deleteOrder" data-id="{{item._id}}">åˆ é™¤</button>
          </view>
        </view>
      </view>

      <view class="empty-state" wx:if="{{orders.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">
          {{searchOrderNo ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è®¢å•' : 'æš‚æ— è®¢å•æ•°æ®'}}
        </text>
      </view>
    </view>

    <!-- é€€æ¬¾ç®¡ç† -->
    <view wx:if="{{currentPage === 'refunds'}}" class="page-content">
      <view class="page-header">
        <text class="page-title">é€€æ¬¾ç®¡ç†</text>
        <button class="refresh-btn" bindtap="refreshRefunds">åˆ·æ–°</button>
      </view>

      <!-- çŠ¶æ€ç­›é€‰ -->
      <view class="filter-section">
        <view class="filter-item">
          <text class="filter-label">çŠ¶æ€ç­›é€‰:</text>
          <picker mode="selector"
                  range="{{refundStatusOptions}}"
                  range-key="text"
                  value="{{refundStatusIndex}}"
                  bindchange="onRefundStatusChange">
            <view class="picker-value">{{refundStatusOptions[refundStatusIndex].text}}</view>
          </picker>
        </view>
      </view>

      <!-- é€€æ¬¾åˆ—è¡¨ -->
      <view class="data-list" wx:if="{{refunds.length > 0}}">
        <view class="refund-item" wx:for="{{refunds}}" wx:key="_id">
          <!-- é€€æ¬¾ä¿¡æ¯åŒºåŸŸ -->
          <view class="refund-info" bindtap="viewRefundDetail" data-id="{{item._id}}">
            <view class="refund-header">
              <text class="refund-id">é€€æ¬¾å•å·: {{item.outRefundNo || item.refundId || item._id}}</text>
              <text class="refund-status status-{{item.status}}">{{item.statusText}}</text>
            </view>
            <view class="refund-details">
              <text class="refund-order">è®¢å•å·: {{item.orderNo || item.orderId}}</text>
              <text class="refund-amount">é€€æ¬¾é‡‘é¢: Â¥{{item.amount}}</text>
            </view>
            <view class="refund-reason">
              <text class="reason-label">é€€æ¬¾åŸå› :</text>
              <text class="reason-text">{{item.reason}}</text>
            </view>
            <view class="refund-meta">
              <text class="refund-time">ç”³è¯·æ—¶é—´: {{item.createTime}}</text>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ - æ”¾åœ¨å¡ç‰‡ä¸‹æ–¹ -->
          <view class="refund-actions-bottom">
            <button class="btn-detail" bindtap="viewRefundDetail" data-id="{{item._id}}">æŸ¥çœ‹è¯¦æƒ…</button>
            <button class="btn-approve"
                    bindtap="approveRefund"
                    data-id="{{item._id}}"
                    wx:if="{{item.status === 'pending'}}">å®¡æ ¸é€šè¿‡</button>
            <button class="btn-reject"
                    bindtap="rejectRefund"
                    data-id="{{item._id}}"
                    wx:if="{{item.status === 'pending'}}">å®¡æ ¸æ‹’ç»</button>
          </view>
        </view>
      </view>

      <view class="empty-state" wx:if="{{refunds.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ’°</text>
        <text class="empty-text">æš‚æ— é€€æ¬¾ç”³è¯·</text>
      </view>
    </view>

    <!-- è½®æ’­å›¾ç®¡ç† -->
    <view wx:if="{{currentPage === 'banners'}}" class="page-content">
      <view class="page-header">
        <text class="page-title">è½®æ’­å›¾ç®¡ç†</text>
        <button class="add-btn" bindtap="addBanner">æ·»åŠ è½®æ’­å›¾</button>
      </view>
      
      <view class="data-list" wx:if="{{banners.length > 0}}">
        <view class="banner-item" wx:for="{{banners}}" wx:key="_id">
          <image src="{{item.imageUrl}}" class="banner-image" mode="aspectFill" />
          <view class="banner-info">
            <text class="banner-title">{{item.title}}</text>
            <text class="banner-desc">{{item.desc}}</text>
            <view class="banner-meta">
              <text class="banner-sort">æ’åº: {{item.sort}}</text>
              <text class="banner-status {{item.status === 'active' ? '' : 'inactive'}}">
                {{item.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}}
              </text>
            </view>
            <view class="banner-actions">
              <button class="btn-secondary" bindtap="editBanner" data-id="{{item._id}}">ç¼–è¾‘</button>
              <button class="btn-danger" bindtap="deleteBanner" data-id="{{item._id}}">åˆ é™¤</button>
              <button class="btn-move" bindtap="moveBannerUp" data-index="{{index}}" wx:if="{{index > 0}}">ä¸Šç§»</button>
              <button class="btn-move" bindtap="moveBannerDown" data-index="{{index}}" wx:if="{{index < banners.length - 1}}">ä¸‹ç§»</button>
              <button class="btn-status-toggle {{item.status === 'active' ? 'btn-danger' : 'btn-primary'}}" 
                      bindtap="toggleBannerStatus" 
                      data-id="{{item._id}}" 
                      data-status="{{item.status}}">
                {{item.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨'}}
              </button>
            </view>
          </view>
        </view>
      </view>
      
      <view class="empty-state" wx:if="{{banners.length === 0 && !loading}}">
        <text>æš‚æ— è½®æ’­å›¾æ•°æ®</text>
      </view>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜ç®¡ç†å¼¹çª— -->
  <view class="admin-modal" wx:if="{{showAdminManage}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç®¡ç†å‘˜ç®¡ç†</text>
        <text class="modal-close" bindtap="hideAdminManagement">Ã—</text>
      </view>
      
      <!-- æ·»åŠ ç®¡ç†å‘˜è¡¨å• -->
      <view class="add-admin-form">
        <view class="form-item">
          <text class="form-label">ç”¨æˆ·OpenID:</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”¨æˆ·openid" 
                 value="{{newAdmin.openid}}"
                 bindinput="onAdminOpenidInput" />
        </view>
        <view class="form-item">
          <text class="form-label">å§“å:</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥å§“å" 
                 value="{{newAdmin.name}}"
                 bindinput="onAdminNameInput" />
        </view>
        <view class="form-item">
          <text class="form-label">æ‰‹æœºå·:</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥æ‰‹æœºå·" 
                 value="{{newAdmin.phone}}"
                 bindinput="onAdminPhoneInput" />
        </view>
        <view class="form-item">
          <text class="form-label">è§’è‰²:</text>
          <picker mode="selector" 
                  range="{{['admin', 'super_admin']}}" 
                  value="{{newAdmin.role === 'super_admin' ? 1 : 0}}"
                  bindchange="onAdminRoleChange">
            <view class="picker-value">{{newAdmin.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'}}</view>
          </picker>
        </view>
        <button class="add-admin-btn" bindtap="addAdmin">æ·»åŠ ç®¡ç†å‘˜</button>
      </view>
      
      <!-- ç®¡ç†å‘˜åˆ—è¡¨ -->
      <view class="admin-list">
        <text class="list-title">å½“å‰ç®¡ç†å‘˜</text>
        <view class="admin-item" wx:for="{{admins}}" wx:key="openid">
          <view class="admin-info">
            <text class="admin-name">{{item.name || 'æœªè®¾ç½®å§“å'}}</text>
            <text class="admin-role">{{item.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'}}</text>
            <text class="admin-openid">{{item.openid}}</text>
          </view>
          <button class="remove-admin-btn" 
                  bindtap="removeAdmin" 
                  data-openid="{{item.openid}}"
                  wx:if="{{item.openid !== currentOpenid}}">ç§»é™¤</button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view> 