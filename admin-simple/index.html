<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅游小程序管理后台 - 简化版</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 登录验证脚本 -->
    <script>
        // 立即检查登录状态
        (function() {
            console.log('开始检查登录状态...');

            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTime = localStorage.getItem('adminLoginTime');
            const currentTime = new Date().getTime();

            console.log('登录状态检查:', {
                isLoggedIn,
                loginTime,
                currentTime,
                timeDiff: loginTime ? (currentTime - parseInt(loginTime)) / (1000 * 60 * 60) : 'N/A',
                isLoggedInValid: !!isLoggedIn,
                isLoginTimeValid: !!loginTime,
                isTimeNotExpired: loginTime ? (currentTime - parseInt(loginTime)) <= 24 * 60 * 60 * 1000 : false
            });

            // 检查是否已登录且未过期（24小时）
            const isLoginValid = isLoggedIn && loginTime && (currentTime - parseInt(loginTime)) <= 24 * 60 * 60 * 1000;

            console.log('登录有效性:', isLoginValid);

            if (!isLoginValid) {
                // 清除过期的登录信息
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminInfo');

                console.log('❌ 未登录或登录已过期，立即跳转到登录页面');

                // 显示跳转提示并立即跳转
                document.body.innerHTML = '<div style="text-align: center; margin-top: 100px; font-family: Arial, sans-serif;"><h2>🔐 正在跳转到登录页面...</h2><p>如果没有自动跳转，请<a href="login.html">点击这里</a></p></div>';

                // 立即跳转到登录页面
                setTimeout(function() {
                    window.location.href = 'login.html';
                }, 500);

                return;
            }

            console.log('✅ 登录状态有效，继续加载页面');
        })();

        // 检查登录状态函数（供其他地方调用）
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTime = localStorage.getItem('adminLoginTime');
            const currentTime = new Date().getTime();

            if (!isLoggedIn || !loginTime || (currentTime - parseInt(loginTime)) > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminInfo');
                window.location.replace('login.html');
                return false;
            }
            return true;
        }
    </script>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-plane"></i> 旅游小程序管理后台</h1>
                <div class="header-actions">
                    <button class="btn-refresh" onclick="refreshCurrentPage()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> 退出登录
                    </button>
                    <div class="connection-status" id="connectionStatus">
                        <i class="fas fa-circle"></i> 连接状态
                    </div>
                </div>
            </div>
        </header>

        <!-- 导航菜单 -->
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchPage('dashboard')" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> 仪表盘
            </button>
            <button class="nav-item" onclick="switchPage('products')" data-page="products">
                <i class="fas fa-map-marked-alt"></i> 产品管理
            </button>
            <button class="nav-item" onclick="switchPage('orders')" data-page="orders">
                <i class="fas fa-shopping-cart"></i> 订单管理
            </button>
            <button class="nav-item" onclick="switchPage('refunds')" data-page="refunds">
                <i class="fas fa-undo-alt"></i> 退款管理
            </button>
            <button class="nav-item" onclick="switchPage('banners')" data-page="banners">
                <i class="fas fa-images"></i> 轮播图管理
            </button>
            <button class="nav-item" onclick="switchPage('settings')" data-page="settings">
                <i class="fas fa-cog"></i> 系统设置
            </button>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 仪表盘 -->
            <div id="dashboard" class="page-content active">
                <div class="page-header">
                    <h2>📊 数据看板</h2>
                    <p>实时业务数据概览</p>
                </div>

                <!-- 核心统计数据 -->
                <div class="stats-grid">
                    <div class="stat-card stat-card-primary">
                        <div class="stat-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="productCount">-</h3>
                            <p>旅游产品</p>
                            <span class="stat-trend">总计</span>
                        </div>
                    </div>

                    <div class="stat-card stat-card-success">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="orderCount">-</h3>
                            <p>订单总数</p>
                            <span class="stat-trend">累计</span>
                        </div>
                    </div>

                    <div class="stat-card stat-card-warning">
                        <div class="stat-icon">
                            <i class="fas fa-undo-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="refundCount">-</h3>
                            <p>退款申请</p>
                            <span class="stat-trend">待处理</span>
                        </div>
                    </div>

                    <div class="stat-card stat-card-info">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="userCount">-</h3>
                            <p>注册用户</p>
                            <span class="stat-trend">活跃</span>
                        </div>
                    </div>
                </div>

                <!-- 业务概览 -->
                <div class="dashboard-grid">
                    <!-- 最近订单 -->
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h3><i class="fas fa-clock"></i> 最近订单</h3>
                            <button class="btn-link" onclick="switchPage('orders')">查看全部 →</button>
                        </div>
                        <div class="table-container">
                            <table class="data-table compact-table">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>产品</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>时间</th>
                                    </tr>
                                </thead>
                                <tbody id="recentOrdersTable">
                                    <tr>
                                        <td colspan="5" class="loading">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 快速操作 -->
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h3><i class="fas fa-bolt"></i> 快速操作</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i>
                                <span>添加产品</span>
                            </button>
                            <button class="quick-action-btn" onclick="switchPage('orders')">
                                <i class="fas fa-search"></i>
                                <span>查看订单</span>
                            </button>
                            <button class="quick-action-btn" onclick="switchPage('refunds')">
                                <i class="fas fa-undo-alt"></i>
                                <span>处理退款</span>
                            </button>
                            <button class="quick-action-btn" onclick="switchPage('banners')">
                                <i class="fas fa-images"></i>
                                <span>轮播图</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 产品管理 -->
            <div id="products" class="page-content">
                <div class="page-header">
                    <h2>产品管理</h2>
                    <button class="btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> 添加产品
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>价格</th>
                                <th>地区</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="6" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 订单管理 -->
            <div id="orders" class="page-content">
                <div class="page-header">
                    <h2>订单管理</h2>
                    <div class="page-actions">
                        <select id="orderStatusFilter" onchange="filterOrders()">
                            <option value="">全部状态</option>
                            <option value="pending">待付款</option>
                            <option value="paid">已付款</option>
                            <option value="confirmed">已确认</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                            <option value="refunded">已退款</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>产品名称</th>
                                <th>用户</th>
                                <th>金额</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="7" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 退款管理 -->
            <div id="refunds" class="page-content">
                <div class="page-header">
                    <h2>退款管理</h2>
                    <div class="page-actions">
                        <select id="refundStatusFilter" onchange="filterRefunds()">
                            <option value="">全部状态</option>
                            <option value="pending">待审核</option>
                            <option value="approved">已通过</option>
                            <option value="rejected">已拒绝</option>
                            <option value="completed">已完成</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>退款单号</th>
                                <th>订单号</th>
                                <th>退款金额</th>
                                <th>退款原因</th>
                                <th>状态</th>
                                <th>申请时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="refundsTable">
                            <tr>
                                <td colspan="7" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 轮播图管理 -->
            <div id="banners" class="page-content">
                <div class="page-header">
                    <h2>轮播图管理</h2>
                    <button class="btn-primary" onclick="showAddBannerModal()">
                        <i class="fas fa-plus"></i> 添加轮播图
                    </button>
                </div>

                <div class="banner-list-container">
                    <div class="banner-grid" id="bannersGrid">
                        <div class="loading-card">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- 系统设置 -->
            <div id="settings" class="page-content">
                <div class="page-header">
                    <h2>系统设置</h2>
                    <p>配置系统参数和连接信息</p>
                </div>
                
                <div class="settings-section">
                    <h3>云开发配置</h3>
                    <div class="form-group">
                        <label for="envIdInput">环境ID:</label>
                        <input type="text" id="envIdInput" placeholder="请输入云开发环境ID">
                    </div>
                    <button class="btn-primary" onclick="saveSettings()">保存配置</button>
                    <button class="btn-secondary" onclick="testConnection()">测试连接</button>
                </div>
                
                <div class="settings-section">
                    <h3>数据库操作</h3>
                    <div class="danger-zone">
                        <button class="btn-danger" onclick="clearCache()">清除缓存</button>
                        <button class="btn-danger" onclick="resetData()">重置数据</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 加载中遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
    </div>

    <!-- 弹窗容器 -->
    <div id="modalContainer"></div>

    <!-- 脚本文件 -->
    <script src="js/config.js"></script>
    <script src="js/cloud-api.js"></script>
    <script src="js/app-simple.js"></script>

    <!-- 登录相关函数 -->
    <script>
        // 退出登录函数
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 清除登录信息
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                // 跳转到登录页面
                window.location.href = 'login.html';
            }
        }

        // 定期检查登录状态（每5分钟检查一次）
        setInterval(function() {
            if (!checkLoginStatus()) {
                alert('登录已过期，请重新登录');
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
