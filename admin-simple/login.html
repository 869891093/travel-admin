<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ç™»å½• - æ—…æ¸¸å°ç¨‹åºç®¡ç†åå°</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-plane"></i>
                    <h1>æ—…æ¸¸ç®¡ç†åå°</h1>
                </div>
                <p class="subtitle">ç®¡ç†å‘˜ç™»å½•</p>
            </div>

            <div class="login-content">
                <!-- ç™»å½•æ–¹å¼é€‰æ‹© -->
                <div class="login-methods">
                    <button class="method-btn active" data-method="openid" type="button">
                        <i class="fas fa-key"></i>
                        <span>OpenIDç™»å½•</span>
                    </button>
                    <button class="method-btn" data-method="qrcode" type="button">
                        <i class="fas fa-qrcode"></i>
                        <span>æ‰«ç ç™»å½•</span>
                    </button>
                </div>

                <!-- OpenIDç™»å½•è¡¨å• -->
                <div id="openidLogin" class="login-form active">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="openid">
                                <i class="fas fa-user"></i>
                                ç®¡ç†å‘˜OpenID
                            </label>
                            <input type="text" id="openid" name="openid" placeholder="è¯·è¾“å…¥æ‚¨çš„OpenID" required>
                            <small class="help-text">OpenIDå¯åœ¨å°ç¨‹åºä¸ªäººä¸­å¿ƒæŸ¥çœ‹</small>
                        </div>

                        <div class="form-group">
                            <label for="adminKey">
                                <i class="fas fa-lock"></i>
                                ç®¡ç†å¯†é’¥ï¼ˆå¯é€‰ï¼‰
                            </label>
                            <input type="password" id="adminKey" name="adminKey" placeholder="ç®¡ç†å¯†é’¥ï¼ˆå¦‚æœ‰è®¾ç½®ï¼‰">
                            <small class="help-text">å¦‚æœè®¾ç½®äº†ç®¡ç†å¯†é’¥ï¼Œè¯·è¾“å…¥</small>
                        </div>

                        <button type="submit" class="login-btn">
                            <i class="fas fa-sign-in-alt"></i>
                            ç™»å½•ç®¡ç†åå°
                        </button>
                    </form>
                </div>

                <!-- æ‰«ç ç™»å½• -->
                <div id="qrcodeLogin" class="login-form">
                    <div class="qrcode-container">
                        <div class="qrcode-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <p>æ‰«ç ç™»å½•åŠŸèƒ½å¼€å‘ä¸­</p>
                            <small>è¯·ä½¿ç”¨OpenIDç™»å½•</small>
                        </div>
                    </div>
                </div>

                <!-- å¸®åŠ©ä¿¡æ¯ -->
                <div class="login-help">
                    <h4><i class="fas fa-question-circle"></i> å¦‚ä½•è·å–OpenIDï¼Ÿ</h4>
                    <ol>
                        <li>æ‰“å¼€æ—…æ¸¸å°ç¨‹åº</li>
                        <li>è¿›å…¥"ä¸ªäººä¸­å¿ƒ"é¡µé¢</li>
                        <li>æŸ¥çœ‹å¹¶å¤åˆ¶æ‚¨çš„OpenID</li>
                        <li>åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­ç²˜è´´OpenID</li>
                    </ol>
                    
                    <div class="admin-info">
                        <h4><i class="fas fa-info-circle"></i> ç®¡ç†å‘˜æƒé™è¯´æ˜</h4>
                        <ul>
                            <li><strong>è¶…çº§ç®¡ç†å‘˜</strong>ï¼šæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œå¯ç®¡ç†å…¶ä»–ç®¡ç†å‘˜</li>
                            <li><strong>æ™®é€šç®¡ç†å‘˜</strong>ï¼šå¯ç®¡ç†äº§å“ã€è®¢å•ã€è½®æ’­å›¾ç­‰</li>
                            <li>éœ€è¦è¶…çº§ç®¡ç†å‘˜åœ¨å°ç¨‹åºä¸­æ·»åŠ æ‚¨ä¸ºç®¡ç†å‘˜</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="login-footer">
                <p>&copy; 2025 æ—…æ¸¸å°ç¨‹åºç®¡ç†ç³»ç»Ÿ</p>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>éªŒè¯ä¸­...</p>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="messageContainer" class="message-container"></div>

    <script src="js/api-simple.js"></script>
    <script>
        // ç®€åŒ–çš„ç™»å½•é€»è¾‘ï¼Œç›´æ¥åœ¨é¡µé¢ä¸­å®ç°
        let loginManager = null;

        // ç­‰å¾…é¡µé¢å’ŒAPIåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');

            // ç­‰å¾…APIåŠ è½½
            function waitForAPI() {
                if (typeof api !== 'undefined') {
                    console.log('APIå·²åŠ è½½ï¼Œåˆå§‹åŒ–ç™»å½•åŠŸèƒ½');
                    initLogin();
                } else {
                    console.log('ç­‰å¾…APIåŠ è½½...');
                    setTimeout(waitForAPI, 100);
                }
            }
            waitForAPI();
        });

        function initLogin() {
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('ç™»å½•è¡¨å•äº‹ä»¶å·²ç»‘å®š');
            }

            // ç»‘å®šåˆ‡æ¢æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    switchMethod(method);
                });
            });

            // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨å¡«å……è¡¨å•
            checkURLParams();
        }

        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const openid = urlParams.get('openid');
            const adminKey = urlParams.get('adminKey');

            console.log('æ£€æŸ¥URLå‚æ•°:', { openid, adminKey });

            if (openid) {
                // å¡«å……è¡¨å•
                const openidInput = document.getElementById('openid');
                const adminKeyInput = document.getElementById('adminKey');

                if (openidInput) {
                    openidInput.value = openid;
                    console.log('å·²å¡«å……OpenID:', openid);
                }

                if (adminKeyInput && adminKey) {
                    adminKeyInput.value = adminKey;
                    console.log('å·²å¡«å……ç®¡ç†å¯†é’¥');
                }

                // è‡ªåŠ¨æäº¤ç™»å½•
                console.log('æ£€æµ‹åˆ°URLå‚æ•°ï¼Œè‡ªåŠ¨è¿›è¡Œç™»å½•...');
                setTimeout(() => {
                    handleLoginWithParams(openid, adminKey || '');
                }, 500);
            }
        }

        async function handleLoginWithParams(openid, adminKey) {
            console.log('ä½¿ç”¨URLå‚æ•°è‡ªåŠ¨ç™»å½•:', { openid, adminKey: adminKey ? '***' : 'ç©º' });

            if (!openid || openid.trim() === '') {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„OpenID', 'error');
                return;
            }

            showLoading('éªŒè¯ç®¡ç†å‘˜æƒé™...');

            try {
                console.log('è°ƒç”¨äº‘å‡½æ•°éªŒè¯æƒé™');

                const result = await api.callCloudFunction('httpAPI', {
                    action: 'checkWebAdmin',
                    openid: openid.trim(),
                    adminKey: adminKey.trim()
                });

                console.log('éªŒè¯ç»“æœ:', result);

                if (result.success && result.isAdmin) {
                    const adminInfo = {
                        openid: openid,
                        name: result.adminInfo?.name || 'ç®¡ç†å‘˜',
                        role: result.adminInfo?.role || 'admin',
                        permissions: result.adminInfo?.permissions || [],
                        isSuperAdmin: result.adminInfo?.role === 'super_admin',
                        loginTime: new Date().toISOString()
                    };

                    // ä¿å­˜ç®¡ç†å‘˜ä¿¡æ¯
                    localStorage.setItem('adminInfo', JSON.stringify(adminInfo));

                    // è®¾ç½®ç™»å½•çŠ¶æ€æ ‡è®°ï¼ˆä¸index.htmlä¿æŒä¸€è‡´ï¼‰
                    const loginTime = new Date().getTime().toString();
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminLoginTime', loginTime);

                    console.log('âœ… ç™»å½•çŠ¶æ€å·²ä¿å­˜:', {
                        adminLoggedIn: localStorage.getItem('adminLoggedIn'),
                        adminLoginTime: localStorage.getItem('adminLoginTime'),
                        adminInfo: localStorage.getItem('adminInfo')
                    });

                    showMessage(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${adminInfo.name}`, 'success');

                    setTimeout(() => {
                        console.log('ğŸš€ å‡†å¤‡è·³è½¬åˆ°ç®¡ç†åå°ï¼Œå†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€:', {
                            adminLoggedIn: localStorage.getItem('adminLoggedIn'),
                            adminLoginTime: localStorage.getItem('adminLoginTime')
                        });
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showMessage(result.message || 'æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·ç¡®è®¤æ‚¨æ˜¯å¦ä¸ºç®¡ç†å‘˜', 'error');
                }

            } catch (error) {
                console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function switchMethod(method) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${method}Login`).classList.add('active');
        }

        async function handleLogin(event) {
            event.preventDefault();
            console.log('å¼€å§‹å¤„ç†ç™»å½•');

            const formData = new FormData(event.target);
            const openid = formData.get('openid').trim();
            const adminKey = formData.get('adminKey').trim();

            if (!openid) {
                showMessage('è¯·è¾“å…¥OpenID', 'error');
                return;
            }

            if (openid.length < 20) {
                showMessage('OpenIDæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥', 'error');
                return;
            }

            showLoading('éªŒè¯ç®¡ç†å‘˜æƒé™...');

            try {
                console.log('è°ƒç”¨äº‘å‡½æ•°éªŒè¯æƒé™');

                // ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šå…ˆæ£€æŸ¥ç®¡ç†å‘˜è¡¨
                let result;
                try {
                    result = await api.callCloudFunction('httpAPI', {
                        action: 'checkWebAdmin',
                        openid: openid,
                        adminKey: adminKey
                    });
                } catch (error) {
                    console.log('checkWebAdminä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æŸ¥è¯¢ç®¡ç†å‘˜è¡¨
                    result = await api.callCloudFunction('httpAPI', {
                        action: 'query',
                        collection: 'admins',
                        where: {
                            openid: openid,
                            status: 'active'
                        }
                    });

                    if (result.success && result.data && result.data.length > 0) {
                        const adminData = result.data[0];
                        result = {
                            success: true,
                            isAdmin: true,
                            adminInfo: {
                                openid: adminData.openid,
                                name: adminData.name || 'ç®¡ç†å‘˜',
                                role: adminData.role || 'admin',
                                permissions: adminData.permissions || ['products', 'orders', 'banners', 'refunds']
                            }
                        };
                    } else {
                        result = {
                            success: false,
                            message: 'è¯¥OpenIDä¸æ˜¯ç®¡ç†å‘˜ï¼Œè¯·è”ç³»è¶…çº§ç®¡ç†å‘˜æ·»åŠ æƒé™'
                        };
                    }
                }

                console.log('éªŒè¯ç»“æœ:', result);

                if (result.success && (result.isAdmin || (result.data && result.data.length > 0))) {
                    const adminInfo = {
                        openid: openid,
                        name: result.adminInfo?.name || 'ç®¡ç†å‘˜',
                        role: result.adminInfo?.role || 'admin',
                        permissions: result.adminInfo?.permissions || [],
                        isSuperAdmin: result.adminInfo?.role === 'super_admin',
                        loginTime: new Date().toISOString()
                    };

                    // ä¿å­˜ç®¡ç†å‘˜ä¿¡æ¯
                    localStorage.setItem('adminInfo', JSON.stringify(adminInfo));

                    // è®¾ç½®ç™»å½•çŠ¶æ€æ ‡è®°ï¼ˆä¸index.htmlä¿æŒä¸€è‡´ï¼‰
                    const loginTime = new Date().getTime().toString();
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminLoginTime', loginTime);

                    console.log('âœ… ç™»å½•çŠ¶æ€å·²ä¿å­˜:', {
                        adminLoggedIn: localStorage.getItem('adminLoggedIn'),
                        adminLoginTime: localStorage.getItem('adminLoginTime'),
                        adminInfo: localStorage.getItem('adminInfo')
                    });

                    showMessage(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${adminInfo.name}`, 'success');

                    setTimeout(() => {
                        console.log('ğŸš€ å‡†å¤‡è·³è½¬åˆ°ç®¡ç†åå°ï¼Œå†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€:', {
                            adminLoggedIn: localStorage.getItem('adminLoggedIn'),
                            adminLoginTime: localStorage.getItem('adminLoginTime')
                        });
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showMessage(result.message || 'æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·ç¡®è®¤æ‚¨æ˜¯å¦ä¸ºç®¡ç†å‘˜', 'error');
                }

            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('p');
            text.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.innerHTML = `
                <div class="message-content">
                    <i class="fas fa-${getMessageIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="message-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(messageEl);

            setTimeout(() => {
                if (messageEl.parentElement) {
                    messageEl.remove();
                }
            }, 5000);
        }

        function getMessageIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }
    </script>

    <style>
        .message {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-success { border-left: 4px solid #28a745; }
        .message-error { border-left: 4px solid #dc3545; }
        .message-warning { border-left: 4px solid #ffc107; }
        .message-info { border-left: 4px solid #17a2b8; }

        .message-success i { color: #28a745; }
        .message-error i { color: #dc3545; }
        .message-warning i { color: #ffc107; }
        .message-info i { color: #17a2b8; }

        .message-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-close:hover {
            color: #495057;
        }
    </style>
</body>
</html>
