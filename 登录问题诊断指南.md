# 🔍 登录问题诊断指南

## 📋 问题现象
用户反馈登录不进去，需要诊断具体原因。

## 🧪 诊断步骤

### 第一步：检查云函数状态
1. **打开微信开发者工具**
2. **进入云开发控制台**
3. **查看云函数列表**，确认以下云函数已部署：
   - ✅ `getOpenid` - 获取用户openid
   - ✅ `getPhoneNumber` - 解密手机号

### 第二步：检查小程序权限
1. **在微信公众平台**查看小程序设置
2. **确认已开通以下权限**：
   - 手机号快速填写与验证
   - 用户信息获取

### 第三步：测试登录流程
1. **打开个人资料页面** (`/pages/profile/profile`)
2. **查看页面状态**：
   - 是否显示登录界面？
   - 是否显示"一键登录"按钮？
3. **点击登录按钮**
4. **查看控制台输出**

### 第四步：检查控制台错误
在微信开发者工具控制台中查找以下错误：

#### 常见错误1：云函数调用失败
```
Error: 云函数调用失败
```
**解决方案**：重新部署相关云函数

#### 常见错误2：权限不足
```
Error: 没有权限访问该资源
```
**解决方案**：检查数据库权限设置

#### 常见错误3：手机号获取失败
```
Error: getPhoneNumber:fail
```
**解决方案**：检查小程序手机号权限

## 🛠️ 修复方案

### 方案1：重新部署云函数
```bash
# 在微信开发者工具中
# 右键 cloudfunctions/getOpenid -> 上传并部署：云端安装依赖
# 右键 cloudfunctions/getPhoneNumber -> 上传并部署：云端安装依赖
```

### 方案2：检查数据库权限
1. **打开云开发控制台**
2. **进入数据库**
3. **检查 `users` 集合权限**
4. **确保允许读写操作**

### 方案3：重置登录状态
在个人资料页面的控制台中执行：
```javascript
// 清除登录状态
this.setData({
  userInfo: null,
  isLoggedIn: false
})
```

## 🔧 临时解决方案

如果登录功能仍有问题，可以启用测试模式：

### 修改 app.js
```javascript
// 在 app.js 中找到这行代码
const testMode = false // 设置为false关闭测试模式

// 临时改为
const testMode = true // 启用测试模式
```

这样可以使用固定的测试openid进行功能测试。

## 📞 获取帮助

如果问题仍未解决，请提供：
1. **具体的错误信息**（控制台截图）
2. **操作步骤描述**
3. **云函数部署状态**
4. **小程序权限配置**

---

**创建时间**: 2025年1月8日  
**版本**: v1.0  
**状态**: 诊断工具
